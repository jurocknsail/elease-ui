"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7966],{17966:(_,A,l)=>{l.r(A),l.d(A,{FilebrowserPageModule:()=>L});var P=l(96814),S=l(60095),i=l(71734),h=l(99351),p=l(15861),y=l(1461),U=l(21450),e=l(85678),D=l(2193),G=l(25472),R=l(29180);const B=["filepicker"];function Y(o,a){1&o&&(e.TgZ(0,"ion-buttons",7),e._UZ(1,"ion-back-button",8),e.qZA())}function J(o,a){1&o&&e._UZ(0,"div",9)}function M(o,a){1&o&&(e.TgZ(0,"ion-text",10)(1,"p"),e._uU(2,"No documents found"),e.qZA()())}function j(o,a){if(1&o){const c=e.EpF();e.TgZ(0,"ion-item-sliding")(1,"ion-item",11),e.NdJ("click",function(){const n=e.CHM(c).$implicit,s=e.oxw();return e.KtG(s.itemClicked(n))}),e._UZ(2,"ion-icon",12),e._uU(3),e.qZA()()}if(2&o){const c=a.$implicit;e.xp6(2),e.Q6J("name",c.isFile?"document-outline":"folder-outline"),e.xp6(1),e.hij(" ",c.name," ")}}const C=y.tP.Documents;let O=(()=>{var o;class a{constructor(t,r,n,s,d,v,u,m){this.route=t,this.router=r,this.previewAnyFile=n,this.platform=s,this.parseService=d,this.loadingController=v,this.toastController=u,this.alertController=m,this.folderContent=[],this.currentFolder="",this.copyFile=null,this.isGreyedOut=!1,this.b64toBlob=(f,g="",x=512)=>{const T=atob(f),I=[];for(let F=0;F<T.length;F+=x){const w=T.slice(F,F+x),E=new Array(w.length);for(let b=0;b<w.length;b++)E[b]=w.charCodeAt(b);const z=new Uint8Array(E);I.push(z)}return new Blob(I,{type:g})},this.alertSendButtons=[{text:"Annuler",role:"cancel"},{text:"OK",role:"confirm",handler:()=>{console.log("Alert confirmed"),this.sendEmail()}}]}ngOnInit(){this.currentFolder=this.route.snapshot.paramMap.get("folder")||"",this.loadDocuments(),console.log("Platform type : "+this.platform.platforms())}toggleGreyOut(){this.isGreyedOut=!this.isGreyedOut}loadDocuments(){var t=this;return(0,p.Z)(function*(){const r=yield y.fy.readdir({directory:C,path:t.currentFolder});t.folderContent=r.files.map(n=>({name:n.name,isFile:"file"===n.type}))})()}itemClicked(t){var r=this;return(0,p.Z)(function*(){if(t.isFile)r.openFile(t);else{let s=encodeURIComponent(""!=r.currentFolder?r.currentFolder+"/"+t.name:t.name);r.router.navigateByUrl(`/filebrowser/${s}`)}})()}openFile(t){var r=this;return(0,p.Z)(function*(){if((0,U.n$)("hybrid")){console.log("cordova");const n=yield y.fy.getUri({directory:C,path:r.currentFolder+"/"+t.name});r.previewAnyFile.preview(n.uri).then(s=>console.log(s)).catch(s=>console.error(s))}else{const n=yield y.fy.readFile({directory:C,path:r.currentFolder+"/"+t.name}),s=r.b64toBlob(n.data,"application/pdf");window.open(URL.createObjectURL(s),"_blank")}})()}presentSendAlert(){var t=this;return(0,p.Z)(function*(){yield(yield t.alertController.create({header:"Confirmation d'envoi",message:"Es-tu s\xfbr(e) de vouloir envoyer les appels de loyers ?",buttons:t.alertSendButtons})).present()})()}sendEmailButton(){this.presentSendAlert()}sendEmail(){var t=this;return(0,p.Z)(function*(){if(t.toggleGreyOut(),0==t.parseService.getLeaseholdersPDFs().size)return void t.toastController.create({message:"Une erreur est survenue, recommence !",duration:3e3,position:"middle",color:"danger",icon:"warning"}).then(d=>{d.onDidDismiss().then(()=>{t.router.navigate(["/"])}),d.present(),t.toggleGreyOut()});let r=[];const n=yield t.loadingController.create({message:"Envoie des emails ..."});yield n.present(),t.parseService.getLeaseholdersPDFs().forEach((s,d)=>{const v=new Promise(u=>{t.parseService.sendEmail(d,s).subscribe({next:m=>{console.log("Email(s) sent successfully from "+d);let f=[];s.forEach(g=>{g.leaseObjectId&&f.push(g.leaseObjectId)}),u(f)},error:m=>{console.error("Error sending email(s) from "+d,m.message),t.toastController.create({message:"Erreur lors de l'envoi pour "+d,duration:3e3,position:"middle",color:"danger",icon:"warning"}).then(g=>{g.onDidDismiss().then(()=>{t.router.navigate(["/"]),t.toggleGreyOut()}),g.present()})}})});r.push(v)}),Promise.all(r).then(s=>{console.log("All emails sent.");const d=s.reduce((u,m)=>u.concat(m),[]);console.log("All leaseId sent :",d),d.forEach(u=>{t.parseService.updateLeaseSendDate(u).then(m=>{t.parseService.getLeaseholders().forEach(f=>{f.leases.forEach(g=>{g.objectId==u&&(g.lastSendDate=m)})})})}),n.dismiss(),t.toastController.create({message:"Tous les emails ont \xe9t\xe9 envoy\xe9s ! Tu les as aussi re\xe7us en copie \u{1f60a}",duration:2e3,position:"middle",color:"primary",icon:"send"}).then(u=>{u.onDidDismiss().then(()=>{t.router.navigate(["/"]),t.toggleGreyOut()}),u.present()})}).catch(s=>{console.log("ERROR Updating leases lastSendDate")})})()}}return(o=a).\u0275fac=function(t){return new(t||o)(e.Y36(h.gz),e.Y36(h.F0),e.Y36(D.R),e.Y36(G.t4),e.Y36(R.X),e.Y36(i.HT),e.Y36(i.yF),e.Y36(i.Br))},o.\u0275cmp=e.Xpm({type:o,selectors:[["app-filebrowser"]],viewQuery:function(t,r){if(1&t&&e.Gf(B,5),2&t){let n;e.iGM(n=e.CRH())&&(r.uploader=n.first)}},decls:13,vars:5,consts:[[3,"color"],["slot","start",4,"ngIf"],["class","overlay",4,"ngIf"],["color","medium","class","ion-padding ion-text-center",4,"ngIf"],[4,"ngFor","ngForOf"],["slot","fixed","vertical","bottom","horizontal","center"],["name","mail-outline",3,"click"],["slot","start"],["text","Retour"],[1,"overlay"],["color","medium",1,"ion-padding","ion-text-center"],[3,"click"],["slot","start",3,"name"]],template:function(t,r){1&t&&(e.TgZ(0,"ion-header")(1,"ion-toolbar",0),e.YNc(2,Y,2,0,"ion-buttons",1),e.TgZ(3,"ion-title"),e._uU(4," Appels de Loyers"),e.qZA()()(),e.YNc(5,J,1,0,"div",2),e.TgZ(6,"ion-content"),e.YNc(7,M,3,0,"ion-text",3),e.TgZ(8,"ion-list"),e.YNc(9,j,4,2,"ion-item-sliding",4),e.qZA(),e.TgZ(10,"ion-fab",5)(11,"ion-fab-button")(12,"ion-icon",6),e.NdJ("click",function(){return r.sendEmailButton()}),e.qZA()()()()),2&t&&(e.xp6(1),e.Q6J("color",r.copyFile?"secondary":"primary"),e.xp6(1),e.Q6J("ngIf",""!==r.currentFolder),e.xp6(3),e.Q6J("ngIf",r.isGreyedOut),e.xp6(2),e.Q6J("ngIf",0===r.folderContent.length),e.xp6(2),e.Q6J("ngForOf",r.folderContent))},dependencies:[P.sg,P.O5,i.Sm,i.W2,i.IJ,i.W4,i.Gu,i.gu,i.Ie,i.td,i.q_,i.yW,i.wd,i.sr,i.oU],styles:[".overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#80808080;z-index:9999;pointer-events:none}"]}),a})();var Z=l(8407);const N=[{path:"",component:O,canActivate:[Z.a]},{path:":folder",component:O,canActivate:[Z.a]}];let Q=(()=>{var o;class a{}return(o=a).\u0275fac=function(t){return new(t||o)},o.\u0275mod=e.oAB({type:o}),o.\u0275inj=e.cJS({imports:[h.Bz.forChild(N),h.Bz]}),a})(),L=(()=>{var o;class a{}return(o=a).\u0275fac=function(t){return new(t||o)},o.\u0275mod=e.oAB({type:o}),o.\u0275inj=e.cJS({imports:[P.ez,S.u5,i.Pc,Q]}),a})()}}]);