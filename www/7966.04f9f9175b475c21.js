"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[7966],{17966:(_,A,l)=>{l.r(A),l.d(A,{FilebrowserPageModule:()=>L});var P=l(96814),S=l(60095),s=l(71734),h=l(99351),p=l(15861),y=l(1461),U=l(21450),e=l(85678),D=l(2193),G=l(25472),R=l(80586);const B=["filepicker"];function Y(o,a){1&o&&(e.TgZ(0,"ion-buttons",7),e._UZ(1,"ion-back-button",8),e.qZA())}function J(o,a){1&o&&e._UZ(0,"div",9)}function M(o,a){1&o&&(e.TgZ(0,"ion-text",10)(1,"p"),e._uU(2,"No documents found"),e.qZA()())}function j(o,a){if(1&o){const c=e.EpF();e.TgZ(0,"ion-item-sliding")(1,"ion-item",11),e.NdJ("click",function(){const r=e.CHM(c).$implicit,i=e.oxw();return e.KtG(i.itemClicked(r))}),e._UZ(2,"ion-icon",12),e._uU(3),e.qZA()()}if(2&o){const c=a.$implicit;e.xp6(2),e.Q6J("name",c.isFile?"document-outline":"folder-outline"),e.xp6(1),e.hij(" ",c.name," ")}}const C=y.tP.Documents;let O=(()=>{var o;class a{constructor(t,n,r,i,d,v,u,g){this.route=t,this.router=n,this.previewAnyFile=r,this.platform=i,this.parseService=d,this.loadingController=v,this.toastController=u,this.alertController=g,this.folderContent=[],this.currentFolder="",this.copyFile=null,this.isGreyedOut=!1,this.b64toBlob=(m,f="",x=512)=>{const T=atob(m),I=[];for(let F=0;F<T.length;F+=x){const w=T.slice(F,F+x),E=new Array(w.length);for(let b=0;b<w.length;b++)E[b]=w.charCodeAt(b);const z=new Uint8Array(E);I.push(z)}return new Blob(I,{type:f})},this.alertSendButtons=[{text:"Annuler",role:"cancel"},{text:"OK",role:"confirm",handler:()=>{console.log("Alert confirmed"),this.sendEmail()}}]}ngOnInit(){this.currentFolder=this.route.snapshot.paramMap.get("folder")||"",this.loadDocuments(),console.log("Platform type : "+this.platform.platforms())}toggleGreyOut(){this.isGreyedOut=!this.isGreyedOut}loadDocuments(){var t=this;return(0,p.Z)(function*(){const n=yield y.fy.readdir({directory:C,path:t.currentFolder});t.folderContent=n.files.map(r=>({name:r.name,isFile:"file"===r.type}))})()}itemClicked(t){var n=this;return(0,p.Z)(function*(){if(t.isFile)n.openFile(t);else{let i=encodeURIComponent(""!=n.currentFolder?n.currentFolder+"/"+t.name:t.name);n.router.navigateByUrl(`/filebrowser/${i}`)}})()}openFile(t){var n=this;return(0,p.Z)(function*(){if((0,U.n$)("hybrid")){console.log("cordova");const r=yield y.fy.getUri({directory:C,path:n.currentFolder+"/"+t.name});n.previewAnyFile.preview(r.uri).then(i=>console.log(i)).catch(i=>console.error(i))}else{const r=yield y.fy.readFile({directory:C,path:n.currentFolder+"/"+t.name}),i=n.b64toBlob(r.data,"application/pdf");window.open(URL.createObjectURL(i),"_blank")}})()}presentSendAlert(){var t=this;return(0,p.Z)(function*(){yield(yield t.alertController.create({header:"Confirmation d'envoi",message:"Es-tu s\xfbr(e) de vouloir envoyer les appels de loyers ?",buttons:t.alertSendButtons})).present()})()}sendEmailButton(){this.presentSendAlert()}sendEmail(){var t=this;return(0,p.Z)(function*(){if(t.toggleGreyOut(),0==t.parseService.getLeaseholdersPDFs().size)return void t.toastController.create({message:"Une erreur est survenue, recommence !",duration:3e3,position:"middle",color:"danger",icon:"warning"}).then(d=>{d.onDidDismiss().then(()=>{t.router.navigate(["/"])}),d.present(),t.toggleGreyOut()});let n=[];const r=yield t.loadingController.create({message:"Envoie des emails ..."});yield r.present(),t.parseService.getLeaseholdersPDFs().forEach((i,d)=>{const v=new Promise(u=>{t.parseService.sendEmail(d,i).subscribe({next:()=>{console.log("Email(s) sent successfully from "+d);let g=[];i.forEach(m=>{m.leaseObjectId&&g.push(m.leaseObjectId)}),u(g)},error:g=>{console.error("Error sending email(s) from "+d,g.message),t.toastController.create({message:"Erreur lors de l'envoi pour "+d,duration:3e3,position:"middle",color:"danger",icon:"warning"}).then(f=>{f.onDidDismiss().then(()=>{t.router.navigate(["/"]),t.toggleGreyOut()}),f.present()})}})});n.push(v)}),Promise.all(n).then(i=>{console.log("All emails sent.");const d=i.reduce((u,g)=>u.concat(g),[]);console.log("All leaseId sent :",d),d.forEach(u=>{t.parseService.updateLeaseSendDate(u).then(g=>{t.parseService.getLeaseholders().forEach(m=>{m.leases.forEach(f=>{f.objectId==u&&(f.lastSendDate=g)})})})}),r.dismiss(),t.toastController.create({message:"Tous les emails ont \xe9t\xe9 envoy\xe9s ! Tu les as aussi re\xe7us en copie \u{1f60a}",duration:2e3,position:"middle",color:"primary",icon:"send"}).then(u=>{u.onDidDismiss().then(()=>{t.router.navigate(["/"]),t.toggleGreyOut()}),u.present()})}).catch(()=>{console.log("ERROR Updating leases lastSendDate")})})()}}return(o=a).\u0275fac=function(t){return new(t||o)(e.Y36(h.gz),e.Y36(h.F0),e.Y36(D.R),e.Y36(G.t4),e.Y36(R.X),e.Y36(s.HT),e.Y36(s.yF),e.Y36(s.Br))},o.\u0275cmp=e.Xpm({type:o,selectors:[["app-filebrowser"]],viewQuery:function(t,n){if(1&t&&e.Gf(B,5),2&t){let r;e.iGM(r=e.CRH())&&(n.uploader=r.first)}},decls:13,vars:5,consts:[[3,"color"],["slot","start",4,"ngIf"],["class","overlay",4,"ngIf"],["color","medium","class","ion-padding ion-text-center",4,"ngIf"],[4,"ngFor","ngForOf"],["slot","fixed","vertical","bottom","horizontal","center"],["name","mail-outline",3,"click"],["slot","start"],["text","Retour"],[1,"overlay"],["color","medium",1,"ion-padding","ion-text-center"],[3,"click"],["slot","start",3,"name"]],template:function(t,n){1&t&&(e.TgZ(0,"ion-header")(1,"ion-toolbar",0),e.YNc(2,Y,2,0,"ion-buttons",1),e.TgZ(3,"ion-title"),e._uU(4," Appels de Loyers"),e.qZA()()(),e.YNc(5,J,1,0,"div",2),e.TgZ(6,"ion-content"),e.YNc(7,M,3,0,"ion-text",3),e.TgZ(8,"ion-list"),e.YNc(9,j,4,2,"ion-item-sliding",4),e.qZA(),e.TgZ(10,"ion-fab",5)(11,"ion-fab-button")(12,"ion-icon",6),e.NdJ("click",function(){return n.sendEmailButton()}),e.qZA()()()()),2&t&&(e.xp6(1),e.Q6J("color",n.copyFile?"secondary":"primary"),e.xp6(1),e.Q6J("ngIf",""!==n.currentFolder),e.xp6(3),e.Q6J("ngIf",n.isGreyedOut),e.xp6(2),e.Q6J("ngIf",0===n.folderContent.length),e.xp6(2),e.Q6J("ngForOf",n.folderContent))},dependencies:[P.sg,P.O5,s.Sm,s.W2,s.IJ,s.W4,s.Gu,s.gu,s.Ie,s.td,s.q_,s.yW,s.wd,s.sr,s.oU],styles:[".overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#80808080;z-index:9999;pointer-events:none}"]}),a})();var Z=l(8407);const N=[{path:"",component:O,canActivate:[Z.a]},{path:":folder",component:O,canActivate:[Z.a]}];let Q=(()=>{var o;class a{}return(o=a).\u0275fac=function(t){return new(t||o)},o.\u0275mod=e.oAB({type:o}),o.\u0275inj=e.cJS({imports:[h.Bz.forChild(N),h.Bz]}),a})(),L=(()=>{var o;class a{}return(o=a).\u0275fac=function(t){return new(t||o)},o.\u0275mod=e.oAB({type:o}),o.\u0275inj=e.cJS({imports:[P.ez,S.u5,s.Pc,Q]}),a})()}}]);